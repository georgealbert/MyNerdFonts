name: Albert Custom Font Build

on:
  push:
    branches:
      - main
  workflow_dispatch: # 允许手动触发该工作流

env:
  FILE_MERGED_WFM: InconsolataNFM+LXGWWenKaiMonoLite
  FUSION_NAME: Inconsolata Nerd Font Mono + LXGW WenKai Mono Lite
  FUSION_ID: InconsolataNFM+LXGWWenKaiMonoLite
  FUSION_DEVELOPER: Albert
  FUSION_DESCRIPTION: "The free and open-source font fused with Iosevka and LXGW WenKai"
  FUSION_COPYRIGHT: Copyright 2025 Albert (${{ github.server_url }}/${{ github.repository }})
  FUSION_LICENSE: "This Font Software is licensed under the SIL Open Font License, Version 1.1. This license is available with a FAQ at: https://openfontlicense.org"
  IOSEVKA_COPYRIGHT: Copyright 2015-2025, Renzhi Li (aka. Belleve Invis, belleve@typeof.net).
  LXGW_COPYRIGHT: Copyright 2021-2024 LXGW (https://github.com/lxgw/LxgwWenKai-Lite) Copyright 2020 The Klee Project Authors (https://github.com/fontworks-fonts/Klee)
  LXGW_WENKAI_LITE: https://github.com/lxgw/LxgwWenKai-Lite/releases/download/v1.520/LXGWWenKaiMonoLite-Regular.ttf

jobs:
  build:
    name: Build my custom fonts
    if: github.repository == 'georgealbert/MyNerdFonts'
    runs-on: ubuntu-latest

    steps:
      # Checkout repository into `mynerdfonts` sub directory
      - uses: actions/checkout@v4
        with:
          path: mynerdfonts

      # - name: Install ttfautohint
      #   shell: bash
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install -y --no-install-recommends ttfautohint

      - name: Install deps for Nerd Font Patcher
        run: sudo apt update && sudo apt install -y fontforge python3-fontforge python3-fonttools p7zip jq gftools

      - name: Download Nerd Font Patcher
        run: |
          wget -q https://github.com/ryanoasis/nerd-fonts/raw/refs/heads/master/FontPatcher.zip
          unzip FontPatcher.zip

      - name: Patch font
        run: |
          ./font-patcher --quiet --adjust-line-height --complete --careful -s mynerdfonts/fonts/Inconsolata-Retina.ttf

      - name: Download LXGWWenKaiMonoLite
        run: |
          wget -q ${LXGW_WENKAI_LITE}

      - name: Merge font by FontForge
        run: |
          for STYLE in "Regular"; do
            fontforge "mynerdfonts/fuse_fonts.ff" \
              "LXGWWenKaiMonoLite-${STYLE}.ttf" \
              "InconsolataNerdFontMono-Retina.ttf" \
              "$FUSION_ID-$STYLE" \
              "$FUSION_NAME" \
              "$FUSION_NAME $STYLE" \
              "$STYLE" \
              "$FUSION_ID-${STYLE}.ttf"
          done

      - name: Set tag name env
        run: |
          echo "NOW=v$(TZ='Asia/Shanghai' date +'%Y%m%d.%H%M%S')" >> $GITHUB_ENV

      - name: Fix fonts
        run: |
          # Fix font agvCharWidth.
          python mynerdfonts/width.py -f 500 InconsolataNerdFontMono-Retina.ttf -l -200 -n 30

          for STYLE in "Regular"; do
            gftools update-nameids "${FUSION_ID}-${STYLE}.ttf" \
              --uniqueid "$FUSION_ID-$STYLE-$NOW" \
              --designer "$FUSION_DEVELOPER" \
              --manufacturer "$FUSION_DEVELOPER" \
              --trademark "$FUSION_NAME" \
              --version "$NOW" \
              --copyright "$(echo -e "$IOSEVKA_COPYRIGHT\n$LXGW_COPYRIGHT\n$FUSION_COPYRIGHT")" \
              --license "$FUSION_LICENSE" \
              --urlvendor "https://github.com/georgealbert/Iosevka" \
              --urldesigner "https://www.albertzhou.net" \
              --urllicense "https://openfontlicense.org"
            mv "${FUSION_ID}-${STYLE}.ttf.fix" "${FUSION_ID}-${STYLE}.ttf"
          done

      - name: Generate artifact info
        run: |
          echo 'release_body<<EOF' >> $GITHUB_ENV
          cd mynerdfonts && git log -1 --oneline >> $GITHUB_ENV
          cd ..

          # Print font info.
          for STYLE in "Regular"; do
            # echo "" >> $GITHUB_ENV
            # echo "# Font Info:" >> $GITHUB_ENV
            # echo "* IosevkaTermSS05NerdFontMono-${STYLE}.ttf:" >> $GITHUB_ENV
            # echo "\`\`\`" >> $GITHUB_ENV
            # python width.py -c IosevkaTermSS05NerdFontMono-${STYLE}.ttf >> $GITHUB_ENV
            # echo "\`\`\`" >> $GITHUB_ENV

            # echo "" >> $GITHUB_ENV
            # echo "* ${FILE_MERGED_WFM}-${STYLE}.ttf:" >> $GITHUB_ENV
            # python mynerdfonts/width.py -c ${FILE_MERGED_WFM}-${STYLE}.ttf >> $GITHUB_ENV

            echo "" >> $GITHUB_ENV
            echo "* ${FUSION_ID}-${STYLE}.ttf:" >> $GITHUB_ENV
            echo "\`\`\`" >> $GITHUB_ENV
            python mynerdfonts/width.py -c ${FUSION_ID}-${STYLE}.ttf >> $GITHUB_ENV
            echo "\`\`\`" >> $GITHUB_ENV
          done

          echo 'EOF' >> $GITHUB_ENV

          echo ${{ env.release_body }}
          
      - name: Publish Release
        id: publish_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.NOW }}
          draft: false
          prerelease: false
          body: >
            1. 合并修改后的Inconsolata-Retina和LXGW WenKai Mono Lite字体。

            ${{ env.release_body }}


            Built with
            [Github Workflow #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          files: |
            InconsolataNerdFontMono-Retina.ttf
            ${{ env.FUSION_ID }}-Regular.ttf
